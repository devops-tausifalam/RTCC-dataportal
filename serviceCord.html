<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=1024" />
    <title>Service Record Form</title>
    <style type="text/css">
      body {
        margin: 0;
        padding: 0;
        width: 100vw; /* Set maximum possible width */
        max-width: 100%; /* Set max width to 100% */
        font-family: Arial, Helvetica, sans-serif;
      }

      /* Global styles for internal elements like button, heading etc */
      button {
        display: inline-block;
        font-weight: 400;
        color: #fff; /* Text color */
        background-color: #007bff; /* Bootstrap primary color */
        border: 1px solid #007bff; /* Match background */
        padding: 0.375rem 0.75rem; /* Padding */
        width: 100%;
        font-size: inherit; /* Keeps original font size */
        line-height: 1.5;
        text-align: center;
        text-decoration: none;
        vertical-align: middle;
        cursor: pointer;
        border-radius: 0.25rem; /* Rounded corners */
        transition: background-color 0.15s ease-in-out,
          border-color 0.15s ease-in-out;
      }

      button:hover {
        background-color: #0056b3; /* Darker blue on hover */
        border-color: #0056b3; /* Match hover background */
        color: #fff; /* Ensure text remains visible */
      }

      /* General form styling */
      label {
        display: inline-block;
        margin-bottom: 0.5rem;
        font-weight: bold;
        font-size: 1rem;
      }

      /* Input and select styles */
      input[type="text"],
      input[type="date"],
      select {
        display: block;
        width: 100%;
        height: calc(1.5em + 0.75rem + 2px); /* Bootstrap-like height */
        padding: 0.375rem 0.75rem; /* Padding */
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #495057;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem; /* Rounded corners */
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }

      /* Hover and focus effects */
      input:focus,
      select:focus {
        color: #495057;
        background-color: #fff;
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); /* Subtle focus effect */
      }

      /* Global Styles ends */
      h1 {
        text-align: center;
      }

      div.content-wrapper {
        display: flex;
        align-items: center;
        justify-content: space-between; /* Space items evenly */
        padding: 1rem;
      }

      div.global-column-container {
        display: flex;
        flex-direction: row;
        width: 100%;
        justify-content: space-between; /* Make the columns take equal width */
      }

      div.column {
        flex: 1; /* Ensure columns take equal space */
        margin: 0 10px; /* Adjust the margin between columns */
      }
      div.column1,
      div.column2 {
        width: 450px;
        max-width: 450px;
      }
      div.column1,
      div.column2 {
        display: flex;
        flex-direction: column;
      }

      div.column2 #serviceTypeForm {
        display: flex;
        flex-direction: column;
        direction: rtl;
        margin: 0 1rem; /* Horizontal margin */
      }

      .checkbox-label {
        display: flex;
        flex-direction: row; /* Align items in a row */
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
        font-weight: bold;
        gap: 0.5rem; /* Space between elements */
      }

      .checkbox-label .english-text {
        font-size: 1.5rem;
        color: #222;
      }

      .checkbox-label .arabic-text {
        font-size: 1.5rem;
        color: #555;
      }

      .checkbox-label input[type="checkbox"] {
        appearance: none;
        width: 1.2rem;
        height: 1.2rem;
        border: 2px solid #007bff;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }

      .checkbox-label input[type="checkbox"]:checked {
        background-color: #007bff;
        border-color: #0056b3;
        color: #fff;
      }

      .checkbox-label input[type="checkbox"]:checked::before {
        content: "✔";
        font-size: 0.9rem;
        color: #fff;
      }

      .checkbox-label span {
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
      }

      /* Table wrapper styles */
      div.table-wrapper {
        display: block;
        width: 100%;
        overflow-x: auto;
        margin-top: 1rem;
        padding: 1rem; /* Padding around the table */
      }

      /* Table styling */
      div.table-wrapper table {
        width: 100%;
        border-collapse: collapse;
      }

      div.table-wrapper th,
      td {
        border: 1px solid #ddd;
        padding: 12px 20px;
        text-align: left;
        font-size: 1rem;
      }

      div.table-wrapper th {
        background-color: #f8f9fa;
        font-weight: bold;
        color: #343a40;
        padding: 12px 20px;
        text-align: center;
      }

      div.table-wrapper td {
        background-color: #fff;
        color: #495057;
        padding: 12px 20px;
        text-align: center;
      }

      /* Hover effect for rows */
      div.table-wrapper tr:hover {
        background-color: #f1f1f1;
      }

      /* Make the header sticky */
      div.table-wrapper table thead {
        position: sticky;
        top: 0;
        background-color: #007bff;
        z-index: 1;
        color: #fff;
      }

      /* Adjust column widths */
      div.table-wrapper th:nth-child(1),
      td:nth-child(1) {
        width: 15%; /* Adjust width for the first column */
      }

      th:nth-child(2),
      td:nth-child(2) {
        width: 15%; /* Adjust width for the second column */
      }

      th:nth-child(3),
      td:nth-child(3) {
        width: 15%; /* Adjust width for the third column */
      }

      th:nth-child(4),
      td:nth-child(4) {
        width: 10%; /* Adjust width for the fourth column */
      }

      th:nth-child(5),
      td:nth-child(5) {
        width: 15%; /* Adjust width for the fifth column */
      }

      div.table-wrapper th,
      div.table-wrapper td {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="content-wrapper">
      <div class="global-column-container">
        <!-- main-form -->
        <div class="column1 column">
          <h1>Machine Information</h1>
          <form id="serviceForm">
            <label for="dateService">Date Service:</label>
            <input type="date" id="dateService" name="dateService" required />

            <label for="model">Model:</label>
            <input type="text" id="model" name="model" required readonly />

            <label for="plateCoNo">Plate / Code:</label>
            <select id="plateCoNo" name="plateCoNo" required>
              <option value="">Select Code</option>
              <!-- Code options will be populated dynamically -->
            </select>

            <label for="hourKM">Hour / K.M:</label>
            <input type="text" id="hourKM" name="hourKM" required />

            <label for="type">Type:</label>
            <input type="text" id="type" name="type" required readonly />

            <label for="site">Site:</label>
            <input
              type="text"
              id="site"
              name="site"
              placeholder="Enter site/location"
              required
            />

            <label for="battery">Battery:</label>
            <input
              type="text"
              id="battery"
              name="battery"
              placeholder="Enter battery details"
            />
            <!-- Battery is optional -->
            <br />
            <!--add a line break to separate inputs from submit-button-->
            <button type="submit">Submit</button>
          </form>
        </div>

        <div class="column2 column">
          <h1>Service Types</h1>
          <form id="serviceTypeForm">
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="oilFilter"
                name="serviceTypes"
                value="OIL FILTER"
              />
              <label for="oilFilter">
                <span class="arabic-text">فلتر زيت</span>
                <span class="english-text">OIL FILTER</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="fuelFilter"
                name="serviceTypes"
                value="FUEL FILTER"
              />
              <label for="fuelFilter">
                <span class="arabic-text">فلتر ديزل</span>
                <span class="english-text">FUEL FILTER</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="waterSep"
                name="serviceTypes"
                value="WATER SEP"
              />
              <label for="waterSep">
                <span class="arabic-text">فلتر سيبر يتر</span>
                <span class="english-text">WATER SEP</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="airFilter"
                name="serviceTypes"
                value="AIR FILTER"
              />
              <label for="airFilter">
                <span class="arabic-text">فلتر هواء</span>
                <span class="english-text">AIR FILTER</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="transmissionFilter"
                name="serviceTypes"
                value="TRANSMISSION FILTER"
              />
              <label for="transmissionFilter">
                <span class="arabic-text">فلتر جير</span>
                <span class="english-text">TRANSMISSION FILTER</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="returnFilter"
                name="serviceTypes"
                value="RETURN FILTER"
              />
              <label for="returnFilter">
                <span class="arabic-text">فلتر هيدروليك</span>
                <span class="english-text">RETURN FILTER</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="drainFilter"
                name="serviceTypes"
                value="DRAIN FILTER"
              />
              <label for="drainFilter">
                <span class="arabic-text">فلتر هيدروليك</span>
                <span class="english-text">DRAIN FILTER</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="lineFilter"
                name="serviceTypes"
                value="LINE FILTER"
              />
              <label for="lineFilter">
                <span class="arabic-text">فلتر هيدروليك</span>
                <span class="english-text">LINE FILTER</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="strainer"
                name="serviceTypes"
                value="STRAINER"
              />
              <label for="strainer">
                <span class="arabic-text">فلتر هيدروليك</span>
                <span class="english-text">STRAINER</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="engineOil"
                name="serviceTypes"
                value="ENGINE OIL"
              />
              <label for="engineOil">
                <span class="arabic-text">زيت محرك</span>
                <span class="english-text">ENGINE OIL</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="hydOil"
                name="serviceTypes"
                value="HYD.OIL"
              />
              <label for="hydOil">
                <span class="arabic-text">زيت هيدروليك</span>
                <span class="english-text">HYD.OIL</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="transmissionOil"
                name="serviceTypes"
                value="TRANSMISSION OIL"
              />
              <label for="transmissionOil">
                <span class="arabic-text">زيت جير</span>
                <span class="english-text">TRANSMISSION OIL</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="finalDriveOil"
                name="serviceTypes"
                value="FINAL DRIVE OIL"
              />
              <label for="finalDriveOil">
                <span class="arabic-text">زيت ديفرينس</span>
                <span class="english-text">FINAL DRIVE OIL</span>
              </label>
            </div>
            <div class="checkbox-label">
              <input
                type="checkbox"
                id="swingMotorOil"
                name="serviceTypes"
                value="SWING MOTOR OIL"
              />
              <label for="swingMotorOil">
                <span class="arabic-text">زيت دوران</span>
                <span class="english-text">SWING MOTOR OIL</span>
              </label>
            </div>
          </form>
        </div>

        <!-- table-container -->
        <div class="table-container column">
          <div class="table-wrapper">
            <h1>SERVICE RECORD</h1>
            <table>
              <tr>
                <th>DATE</th>
                <th>MODEL</th>
                <th>CO.NO</th>
                <th>HOUR</th>
                <th>TYPE</th>
              </tr>
              <!-- Add 10 empty rows -->
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
    <script>
      async function fetchMachinesData() {
        try {
          const data = await google.script.run
            .withSuccessHandler((data) => {
              populateCoNoDropdown(data);
              localStorage.setItem("machinesData", JSON.stringify(data)); // Store data in localStorage
            })
            .fetchMachinesData();
        } catch (error) {
          console.error("Error fetching machines data:", error);
        }
      }

      function populateCoNoDropdown(machines) {
        const plateCoNoSelect = document.getElementById("plateCoNo");

        // Clear existing options
        plateCoNoSelect.innerHTML = '<option value="">Select Code</option>';

        machines.forEach((machine) => {
          const option = document.createElement("option");
          option.value = machine.code; // Use 'code' from JSON
          option.textContent = machine.code; // Display 'code' in dropdown
          plateCoNoSelect.appendChild(option);
        });
        console.log("Dropdown populated with Codes.");
      }

      document
        .getElementById("plateCoNo")
        .addEventListener("change", function () {
          const selectedCode = this.value;
          const modelInput = document.getElementById("model");

          if (!selectedCode) {
            modelInput.value = ""; // Clear field if no valid selection
            return;
          }

          // Fetch machines data from localStorage
          const machines =
            JSON.parse(localStorage.getItem("machinesData")) || [];
          const selectedMachine = machines.find(
            (machine) => machine.code === selectedCode
          );

          if (selectedMachine) {
            modelInput.value = selectedMachine.model; // Set model if found
          } else {
            modelInput.value = ""; // Clear field if no valid selection
          }
        });

      // Function to update the type input based on selected checkboxes and battery input
      function updateType() {
        const engineOil = document.getElementById("engineOil").checked;
        const oilFilter = document.getElementById("oilFilter").checked;
        const airFilter = document.getElementById("airFilter").checked;
        const hydOil = document.getElementById("hydOil").checked;
        const returnFilter = document.getElementById("returnFilter").checked;
        const transmissionOil =
          document.getElementById("transmissionOil").checked;
        const transmissionFilter =
          document.getElementById("transmissionFilter").checked;

        let type = "";

        if (engineOil) {
          type += "E.O";
        }

        if (oilFilter && engineOil) {
          type += (type ? "+" : "") + "F";
        }

        if (airFilter) {
          type = "A.F";
        }

        if (hydOil) {
          type = "H.O";
        }

        if (returnFilter && hydOil) {
          type += (type ? "+" : "") + "F";
        }

        if (transmissionOil) {
          type = "T.O";
        }

        if (transmissionFilter && transmissionOil) {
          type += (type ? "+" : "") + "F";
        }

        // Check the Battery input value and append to type
        const batteryValue = document.getElementById("battery").value.trim();
        if (batteryValue) {
          type += (type ? "+" : "") + "Battery"; // Append 'Battery' if Battery field is filled
        }

        document.getElementById("type").value = type; // Update the type input
      }

      // Add event listeners to checkboxes to update the type on change
      document
        .querySelectorAll('#serviceTypeForm input[type="checkbox"]')
        .forEach((checkbox) => {
          checkbox.addEventListener("change", () => {
            updateType();
          });
        });

      // Add event listener for the battery input to update type on input
      document.getElementById("battery").addEventListener("input", () => {
        updateType();
      });

      // Fetch the data when the window loads
      window.onload = fetchMachinesData;

      document
        .getElementById("serviceForm")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // Prevent default form submission

          const formData = new FormData(event.target);
          const serviceTypes = [];

          // Collect all checked service types
          document
            .querySelectorAll('#serviceTypeForm input[type="checkbox"]:checked')
            .forEach((checkbox) => {
              serviceTypes.push(checkbox.value);
            });

          const data = {
            dateService: formData.get("dateService"),
            model: formData.get("model"),
            plateCoNo: formData.get("plateCoNo"),
            hourKM: formData.get("hourKM"),
            type: formData.get("type"), // Include type in the data object
            site: formData.get("site"),
            battery: formData.get("battery"), // Include battery in the data object
            serviceTypes: serviceTypes, // Include service types in the data object
          };

          // Debugging: Log the data to be sent
          console.log("Form data to be sent:", data);

          // Validate the data
          if (
            !data.dateService ||
            !data.model ||
            !data.plateCoNo ||
            !data.hourKM ||
            !data.type ||
            !data.site
          ) {
            console.error("Validation failed. One or more fields are missing.");
            return; // Exit if validation fails
          }

          // Call the server-side function to save data
          google.script.run
            .withSuccessHandler((response) => {
              console.log("Data saved successfully:", response);
              event.target.reset(); // Reset the form after successful submission

              // Clear all checkboxes in the service` type form
              document
                .querySelectorAll('#serviceTypeForm input[type="checkbox"]')
                .forEach((checkbox) => {
                  checkbox.checked = false; // Uncheck each checkbox
                });
              document.getElementById("type").value = ""; // Clear type input
            })
            .saveServiceData(data);
        });
    </script>

    <!-- Hidden input fields for columns F to S and T, U -->
    <input type="text" id="colF" style="display: none" />
    <input type="text" id="colG" style="display: none" />
    <input type="text" id="colH" style="display: none" />
    <input type="text" id="colI" style="display: none" />
    <input type="text" id="colJ" style="display: none" />
    <input type="text" id="colK" style="display: none" />
    <input type="text" id="colL" style="display: none" />
    <input type="text" id="colM" style="display: none" />
    <input type="text" id="colT" style="display: none" />
    <input type="text" id="colU" style="display: none" />
  </body>
</html>
