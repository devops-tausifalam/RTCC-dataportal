<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Record Form</title>
    <style>
        /* Basic styling for the form */
        body {
            font-family: Arial, sans-serif;
            margin: 0; /* Remove default body margin */
          /*  display: flex;
            justify-content: center; */
        }

        .form-container {
            display: flex;
            width: 60vw; /* Set the width of the form container to 60% of the viewport */
            max-width: 1000px; /* Maximum width for larger screens */
        }

        .column-container {
           /* flex: 1;
            padding: 15px; */
            float: left;
            display: flex;
            align-items: center;
            padding: 25px;
           /* justify-content: center; */
        }

        .column1 h1 {
            text-align: center;
            color: blue;
            font-weight: bold;
            font-size: 2rem; /* Reduced font size for headers */
        }
         .column2 h1 {
            text-align: center;
            color: blue;
            font-weight: bold;
            font-size: 2rem; /* Reduced font size for headers */
            margin-top: 45px;
        }
        .column2{
          margin-bottom: calc(623.594px - 503.391px)
        }
        label {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 5px; /* Reduced margin for labels */
            color: blue;
            font-weight: bold;
        }

        input[type="text"],
        input[type="date"],
        select {
            width: 50%; /* Reduced input width to make it more compact */
            padding: 4px; /* Reduced padding */
            font-size: 13px; /* Reduced font size */
            margin-bottom: 8px; /* Maintained margin below inputs */
        }

        input[type="checkbox"] {
            margin-right: 2px; /* Reduced right margin for checkboxes */
            transform: scale(1.5); /* Increased the size of the checkboxes */
            cursor: pointer; /* Change the cursor to pointer for better UX */
        }

        .checkbox-label {
            display: flex;
            align-items: center; /* Center vertically */
            width: 100%;
            margin-bottom: 2px; /* Reduced margin below checkbox labels */
            padding-left: 0; /* Ensure no extra padding to the left */
        }

        .arabic-text {
            margin-left: 15px; /* Increased left margin for Arabic text */
            direction: rtl; /* Ensure text is displayed correctly */
            text-align: left; /* Align Arabic text to the left */
            flex: 0; /* Allow to only take the necessary space */
            white-space: nowrap; /* Prevent Arabic text from wrapping */
        }

        .english-text {
            margin-left: 30px; /* Increased space to the left of English text */
            text-align: left; /* Align English text to left as well */
        }

        form {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        button {
            padding: 8px 15px; /* Reduced padding for buttons */
            font-size: 14px; /* Reduced font size for buttons */
            color: white;
            background-color: blue;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 5px; /* Reduced margin above button */
        }

        button:hover {
            background-color: darkblue;
        }
    </style>
</head>
<body>
    <div class="form-container">
      <div class="column-container column">
        <div class="column1">
            <h1>Machine Information</h1>
            <form id="serviceForm">
                <label for="dateService">Date Service:</label>
                <input type="date" id="dateService" name="dateService" required>

                <label for="model">Model:</label>
                <input type="text" id="model" name="model" required readonly>

                <label for="plateCoNo">Plate / Code:</label>
                <select id="plateCoNo" name="plateCoNo" required>
                    <option value="">Select Code</option>
                    <!-- Code options will be populated dynamically -->
                </select>

                <label for="hourKM">Hour / K.M:</label>
                <input type="text" id="hourKM" name="hourKM" required>

                <label for="type">Type:</label>
                <input type="text" id="type" name="type" required readonly>

                <label for="site">Site:</label>
                <input type="text" id="site" name="site" placeholder="Enter site/location" required>

                <label for="battery">Battery:</label>
                <input type="text" id="battery" name="battery" placeholder="Enter battery details"> <!-- Battery is optional -->

                <button type="submit">Submit</button>
            </form>
        </div>

        <div class="column2">
            <h1>Service Types</h1>
            <form id="serviceTypeForm">
                <div class="checkbox-label">
                    <input type="checkbox" id="oilFilter" name="serviceTypes" value="OIL FILTER">
                    <label for="oilFilter">
                        <span class="arabic-text">فلتر زيت</span>
                        <span class="english-text">OIL FILTER</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="fuelFilter" name="serviceTypes" value="FUEL FILTER">
                    <label for="fuelFilter">
                        <span class="arabic-text">فلتر ديزل</span>
                        <span class="english-text">FUEL FILTER</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="waterSep" name="serviceTypes" value="WATER SEP">
                    <label for="waterSep">
                        <span class="arabic-text">فلتر سيبر يتر</span>
                        <span class="english-text">WATER SEP</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="airFilter" name="serviceTypes" value="AIR FILTER">
                    <label for="airFilter">
                        <span class="arabic-text">فلتر هواء</span>
                        <span class="english-text">AIR FILTER</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="transmissionFilter" name="serviceTypes" value="TRANSMISSION FILTER">
                    <label for="transmissionFilter">
                        <span class="arabic-text">فلتر جير</span>
                        <span class="english-text">TRANSMISSION FILTER</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="returnFilter" name="serviceTypes" value="RETURN FILTER">
                    <label for="returnFilter">
                        <span class="arabic-text">فلتر هيدروليك</span>
                        <span class="english-text">RETURN FILTER</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="drainFilter" name="serviceTypes" value="DRAIN FILTER">
                    <label for="drainFilter">
                        <span class="arabic-text">فلتر هيدروليك</span>
                        <span class="english-text">DRAIN FILTER</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="lineFilter" name="serviceTypes" value="LINE FILTER">
                    <label for="lineFilter">
                        <span class="arabic-text">فلتر هيدروليك</span>
                        <span class="english-text">LINE FILTER</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="strainer" name="serviceTypes" value="STRAINER">
                    <label for="strainer">
                        <span class="arabic-text">فلتر هيدروليك</span>
                        <span class="english-text">STRAINER</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="engineOil" name="serviceTypes" value="ENGINE OIL">
                    <label for="engineOil">
                        <span class="arabic-text">زيت محرك</span>
                        <span class="english-text">ENGINE OIL</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="hydOil" name="serviceTypes" value="HYD.OIL">
                    <label for="hydOil">
                        <span class="arabic-text">زيت هيدروليك</span>
                        <span class="english-text">HYD.OIL</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="transmissionOil" name="serviceTypes" value="TRANSMISSION OIL">
                    <label for="transmissionOil">
                        <span class="arabic-text">زيت جير</span>
                        <span class="english-text">TRANSMISSION OIL</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="finalDriveOil" name="serviceTypes" value="FINAL DRIVE OIL">
                    <label for="finalDriveOil">
                        <span class="arabic-text">زيت ديفرينس</span>
                        <span class="english-text">FINAL DRIVE OIL</span>
                    </label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="swingMotorOil" name="serviceTypes" value="SWING MOTOR OIL">
                    <label for="swingMotorOil">
                        <span class="arabic-text">زيت دوران</span>
                        <span class="english-text">SWING MOTOR OIL</span>
                    </label>
                </div>
            </form>
        </div>
        </div>
    </div>

    <script>
        async function fetchMachinesData() {
            try {
                const data = await google.script.run.withSuccessHandler(data => {
                    populateCoNoDropdown(data);
                    localStorage.setItem('machinesData', JSON.stringify(data)); // Store data in localStorage
                }).fetchMachinesData();
            } catch (error) {
                console.error('Error fetching machines data:', error);
            }
        }

        function populateCoNoDropdown(machines) {
            const plateCoNoSelect = document.getElementById('plateCoNo');

            // Clear existing options
            plateCoNoSelect.innerHTML = '<option value="">Select Code</option>';

            machines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.code; // Use 'code' from JSON
                option.textContent = machine.code; // Display 'code' in dropdown
                plateCoNoSelect.appendChild(option);
            });
            console.log('Dropdown populated with Codes.');
        }

        document.getElementById('plateCoNo').addEventListener('change', function () {
            const selectedCode = this.value;
            const modelInput = document.getElementById('model');

            if (!selectedCode) {
                modelInput.value = ''; // Clear field if no valid selection
                return;
            }

            // Fetch machines data from localStorage
            const machines = JSON.parse(localStorage.getItem('machinesData')) || [];
            const selectedMachine = machines.find(machine => machine.code === selectedCode);

            if (selectedMachine) {
                modelInput.value = selectedMachine.model; // Set model if found
            } else {
                modelInput.value = ''; // Clear field if no valid selection
            }
        });

        // Function to update the type input based on selected checkboxes and battery input
        function updateType() {
            const engineOil = document.getElementById('engineOil').checked;
            const oilFilter = document.getElementById('oilFilter').checked;
            const airFilter = document.getElementById('airFilter').checked;
            const hydOil = document.getElementById('hydOil').checked;
            const returnFilter = document.getElementById('returnFilter').checked;
            const transmissionOil = document.getElementById('transmissionOil').checked;
            const transmissionFilter = document.getElementById('transmissionFilter').checked;

            let type = '';

            if (engineOil) {
                type += 'E.O';
            }

            if (oilFilter && engineOil) {
                type += (type ? '+' : '') + 'F';
            }

            if (airFilter) {
                type = 'A.F';
            }

            if (hydOil) {
                type = 'H.O';
            }

            if (returnFilter && hydOil) {
                type += (type ? '+' : '') + 'F';
            }

            if (transmissionOil) {
                type = 'T.O';
            }

            if (transmissionFilter && transmissionOil) {
                type += (type ? '+' : '') + 'F';
            }

            // Check the Battery input value and append to type
            const batteryValue = document.getElementById('battery').value.trim();
            if (batteryValue) {
                type += (type ? '+' : '') + 'Battery'; // Append 'Battery' if Battery field is filled
            }

            document.getElementById('type').value = type; // Update the type input
        }

        // Add event listeners to checkboxes to update the type on change
        document.querySelectorAll('#serviceTypeForm input[type="checkbox"]').forEach((checkbox) => {
            checkbox.addEventListener('change', () => {
                updateType();
            });
        });

        // Add event listener for the battery input to update type on input
        document.getElementById('battery').addEventListener('input', () => {
            updateType();
        });

        // Fetch the data when the window loads
        window.onload = fetchMachinesData;

        document.getElementById('serviceForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission

            const formData = new FormData(event.target);
            const serviceTypes = [];

            // Collect all checked service types
            document.querySelectorAll('#serviceTypeForm input[type="checkbox"]:checked').forEach((checkbox) => {
                serviceTypes.push(checkbox.value);
            });

            const data = {
                dateService: formData.get('dateService'),
                model: formData.get('model'),
                plateCoNo: formData.get('plateCoNo'),
                hourKM: formData.get('hourKM'),
                type: formData.get('type'), // Include type in the data object
                site: formData.get('site'),
                battery: formData.get('battery'), // Include battery in the data object
                serviceTypes: serviceTypes // Include service types in the data object
            };

            // Debugging: Log the data to be sent
            console.log("Form data to be sent:", data);

            // Validate the data 
            if (!data.dateService || !data.model || !data.plateCoNo || !data.hourKM || !data.type || !data.site) {
                console.error('Validation failed. One or more fields are missing.');
                return; // Exit if validation fails
            }

            // Call the server-side function to save data
            google.script.run.withSuccessHandler((response) => {
                console.log('Data saved successfully:', response);
                event.target.reset(); // Reset the form after successful submission

                // Clear all checkboxes in the service type form
                document.querySelectorAll('#serviceTypeForm input[type="checkbox"]').forEach((checkbox) => {
                    checkbox.checked = false; // Uncheck each checkbox
                });
                document.getElementById('type').value = ''; // Clear type input
            }).saveServiceData(data);
        });
    </script>

    <!-- Hidden input fields for columns F to S and T, U -->
    <input type="text" id="colF" style="display: none;">
    <input type="text" id="colG" style="display: none;">
    <input type="text" id="colH" style="display: none;">
    <input type="text" id="colI" style="display: none;">
    <input type="text" id="colJ" style="display: none;">
    <input type="text" id="colK" style="display: none;">
    <input type="text" id="colL" style="display: none;">
    <input type="text" id="colM" style="display: none;">
    <input type="text" id="colT" style="display: none;">
    <input type="text" id="colU" style="display: none;">
</body>
</html>
